<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFS Inspections - Dealership Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dealership.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Main Container -->
    <div class="dealership-container">
        <!-- Header -->
        <header class="dealership-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="logo-section">
                        <img src="{{ url_for('static', filename='images/dark-logo.svg') }}" alt="Logo" class="header-logo">
                        <div class="header-title">
                            <h1>SFS Inspections</h1>
                            <p>Second Free Service at 5000km</p>
                        </div>
                    </div>
                </div>
                
                <div class="header-right">
                    <div class="header-actions">
                        <button class="header-btn" onclick="toggleTheme()">
                            <span class="theme-icon">üåô</span>
                        </button>
                        <button class="header-btn" onclick="window.location.href='/chatbot_advanced'">
                            <span>üí¨</span>
                            <span>Chat AI</span>
                        </button>
                        <div class="user-menu">
                            <button class="user-btn">
                                <span class="user-avatar">{{ user.username[0].upper() if user else 'U' }}</span>
                                <span class="user-name">{{ user.username if user else 'User' }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="dealership-nav">
            <div class="nav-content">
                <div class="nav-sections">
                    <a href="/dealership" class="nav-item">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-text">Dashboard</span>
                    </a>
                    <a href="/dealership/warranty-claims" class="nav-item">
                        <span class="nav-icon">‚ö†Ô∏è</span>
                        <span class="nav-text">Warranty Claims</span>
                    </a>
                    <a href="/dealership/campaign-reports" class="nav-item">
                        <span class="nav-icon">üìã</span>
                        <span class="nav-text">Campaign Reports</span>
                    </a>
                    <a href="/dealership/ffs-inspections" class="nav-item">
                        <span class="nav-icon">üîç</span>
                        <span class="nav-text">FFS Inspections</span>
                    </a>
                    <a href="/dealership/sfs-inspections" class="nav-item active">
                        <span class="nav-icon">üîé</span>
                        <span class="nav-text">SFS Inspections</span>
                    </a>
                    <a href="/dealership/pdi-inspections" class="nav-item">
                        <span class="nav-icon">üìù</span>
                        <span class="nav-text">PDI Inspections</span>
                    </a>
                    <a href="/dealership/repair-orders" class="nav-item">
                        <span class="nav-icon">üîß</span>
                        <span class="nav-text">Repair Orders</span>
                    </a>
                    <a href="/dealership/vin-history" class="nav-item">
                        <span class="nav-icon">üöó</span>
                        <span class="nav-text">VIN History</span>
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="dealership-main">
            <!-- Filters Section -->
            <section class="filters-section">
                <div class="section-header">
                    <h2>SFS Inspection Filters</h2>
                    <p>Filter second free service inspections by VIN, dealership, and date</p>
                </div>
                
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="vinFilter">VIN Number</label>
                        <input type="text" id="vinFilter" placeholder="Enter VIN number" maxlength="17" onchange="applyFilters()">
                    </div>
                    
                    <div class="filter-group">
                        <label for="dealershipFilter">Dealership</label>
                        <select id="dealershipFilter" onchange="applyFilters()">
                            <option value="">All Dealerships</option>
                            <option value="Haval Central">Haval Central</option>
                            <option value="Haval Lahore">Haval Lahore</option>
                            <option value="Haval Karachi">Haval Karachi</option>
                            <option value="Haval Islamabad">Haval Islamabad</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="carModelFilter">Car Model</label>
                        <select id="carModelFilter" onchange="applyFilters()">
                            <option value="">All Models</option>
                            <option value="Haval H6">Haval H6</option>
                            <option value="Haval Jolion">Haval Jolion</option>
                            <option value="Haval H6 PHEV">Haval H6 PHEV</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="dateFrom">Date From</label>
                        <input type="date" id="dateFrom" onchange="applyFilters()">
                    </div>
                    
                    <div class="filter-group">
                        <label for="dateTo">Date To</label>
                        <input type="date" id="dateTo" onchange="applyFilters()">
                    </div>
                    
                    <div class="filter-actions">
                        <button class="filter-btn clear" onclick="clearFilters()">
                            <span>üóëÔ∏è</span>
                            <span>Clear</span>
                        </button>
                        <button class="filter-btn export" onclick="exportData('sfs_inspections')">
                            <span>üì§</span>
                            <span>Export</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- SFS Statistics -->
            <section class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üîé</div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.total_inspections or 0 }}</div>
                            <div class="stat-label">Total SFS Inspections</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <div class="stat-number">{{ inspections|length or 0 }}</div>
                            <div class="stat-label">Filtered Results</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üè¢</div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.top_dealerships|length or 0 }}</div>
                            <div class="stat-label">Active Dealerships</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üõ£Ô∏è</div>
                        <div class="stat-content">
                            <div class="stat-number">{{ "{:,.0f}".format(stats.avg_mileage) if stats.avg_mileage else 0 }} km</div>
                            <div class="stat-label">Average Mileage</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SFS Data Table -->
            <section class="data-section">
                <div class="section-header">
                    <h2>SFS Inspection Records</h2>
                    <p>Detailed second free service inspection data</p>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>VIN Number</th>
                                <th>Dealership</th>
                                <th>Car Model</th>
                                <th>Inspection Date</th>
                                <th>Odometer (km)</th>
                                <th>Findings</th>
                                <th>Recommendations</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if inspections %}
                                {% for inspection in inspections %}
                                <tr>
                                    <td>
                                        <div class="cell-content">
                                            <strong class="vin-number">{{ inspection.vin_number or 'N/A' }}</strong>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="cell-content">
                                            <span class="dealership-badge">{{ inspection.dealership_name or 'N/A' }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="cell-content">
                                            {{ inspection.car_model or 'N/A' }}
                                            {% if inspection.variant %}
                                            <small class="variant">{{ inspection.variant }}</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="cell-content">
                                            {{ inspection.inspection_date or 'N/A' }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="cell-content">
                                            <span class="odometer-reading">{{ inspection.odometer_reading or 'N/A' }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="cell-content">
                                            <div class="findings-preview">
                                                {{ (inspection.findings or 'No findings')[:40] }}
                                                {% if inspection.findings and inspection.findings|length > 40 %}...{% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="cell-content">
                                            <div class="recommendations-preview">
                                                {{ (inspection.recommendations or 'None')[:40] }}
                                                {% if inspection.recommendations and inspection.recommendations|length > 40 %}...{% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="cell-content">
                                            <span class="status-badge {{ inspection.status or 'completed' }}">
                                                {{ inspection.status or 'Completed' }}
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="cell-actions">
                                            <button class="action-btn view" onclick="viewSFSDetails('{{ inspection.vin_number }}')">
                                                <span>üëÅÔ∏è</span>
                                            </button>
                                            <button class="action-btn edit" onclick="editSFS('{{ inspection.id }}')">
                                                <span>‚úèÔ∏è</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="9" class="no-data">
                                    <div class="no-data-content">
                                        <span class="no-data-icon">üîé</span>
                                        <h3>No SFS Inspection Data</h3>
                                        <p>No second free service inspections found matching your criteria.</p>
                                        <button class="add-btn" onclick="addNewSFS()">
                                            <span>‚ûï</span>
                                            <span>Add New SFS</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- SFS Analytics -->
            <section class="analytics-section">
                <div class="section-header">
                    <h2>SFS Analytics</h2>
                    <p>Visual insights into second free service performance</p>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>SFS by Dealership</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="dealershipSFSChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Monthly SFS Trend</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="monthlySFSChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Service Completion Rate</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="completionRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/dealership.js') }}"></script>
    <script>
        // SFS-specific functions
        function viewSFSDetails(vinNumber) {
            console.log('Viewing SFS details for VIN:', vinNumber);
            window.location.href = `/dealership/vin-history?vin=${vinNumber}`;
        }

        function editSFS(sfsId) {
            console.log('Editing SFS:', sfsId);
            showNotification('SFS editing coming soon!', 'info');
        }

        function addNewSFS() {
            console.log('Adding new SFS inspection');
            showNotification('Add new SFS functionality coming soon!', 'info');
        }

        function clearFilters() {
            document.getElementById('vinFilter').value = '';
            document.getElementById('dealershipFilter').value = '';
            document.getElementById('carModelFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            applyFilters();
        }

        // Initialize charts
        document.addEventListener('DOMContentLoaded', function() {
            initializeSFSCharts();
        });

        function initializeSFSCharts() {
            // Dealership SFS chart
            const dealershipData = {
                labels: ['Haval Central', 'Haval Lahore', 'Haval Karachi', 'Haval Islamabad'],
                datasets: [{
                    label: 'SFS Completed',
                    data: [72, 58, 45, 38],
                    backgroundColor: 'rgba(168, 85, 247, 0.8)',
                    borderColor: 'rgba(168, 85, 247, 1)',
                    borderWidth: 2
                }]
            };

            createChart('dealershipSFSChart', 'bar', dealershipData);

            // Monthly SFS trend
            const monthlyData = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'SFS Inspections',
                    data: [38, 42, 41, 48, 46, 52],
                    backgroundColor: 'rgba(168, 85, 247, 0.2)',
                    borderColor: 'rgba(168, 85, 247, 1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            };

            createChart('monthlySFSChart', 'line', monthlyData);

            // Service completion rate
            const completionData = {
                labels: ['Completed', 'Pending', 'Overdue'],
                datasets: [{
                    data: [85, 12, 3],
                    backgroundColor: [
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ],
                    borderColor: [
                        'rgba(16, 185, 129, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 2
                }]
            };

            createChart('completionRateChart', 'doughnut', completionData);
        }

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            
            const themeIcon = document.querySelector('.theme-icon');
            themeIcon.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            
            localStorage.setItem('theme', newTheme);
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeIcon = document.querySelector('.theme-icon');
            if (themeIcon) {
                themeIcon.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            }
        });
    </script>
</body>
</html>